<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falcon Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e4;
            padding: 1rem;
        }
        .container { max-width: 1600px; margin: 0 auto; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #333;
            margin-bottom: 1.5rem;
        }
        h1 { color: #00d4ff; font-size: 1.8rem; }
        .nav-links a {
            color: #00d4ff;
            text-decoration: none;
            margin-left: 1.5rem;
            font-size: 0.9rem;
        }
        .nav-links a:hover { text-decoration: underline; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #333;
        }
        .stat-card h3 {
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-bottom: 0.3rem;
        }
        .stat-card .value {
            font-size: 1.4rem;
            color: #fff;
            font-weight: 600;
        }
        .positive { color: #6bcb77 !important; }
        .negative { color: #ff6b6b !important; }

        /* Chart Panels */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .charts-row.equal {
            grid-template-columns: 1fr 1fr;
        }

        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1.25rem;
            border: 1px solid #333;
        }
        .panel h2 {
            color: #00d4ff;
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-controls {
            display: flex;
            gap: 0.5rem;
        }
        .panel-controls button {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .panel-controls button.active {
            background: #00d4ff;
            color: #1a1a2e;
            border-color: #00d4ff;
        }
        .panel-controls button:hover:not(.active) {
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }
        .chart-container.tall {
            height: 400px;
        }

        /* Strategy Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.6rem;
            text-align: left;
            border-bottom: 1px solid #333;
            font-size: 0.85rem;
        }
        th {
            color: #888;
            font-weight: 600;
        }
        td { color: #e4e4e4; }
        .strategy-name { font-weight: 600; color: #00d4ff; }

        /* Loading & Error */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        .error { color: #ff6b6b; }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Backtest Analytics</h1>
            <nav class="nav-links">
                <a href="/">Home</a>
                <a href="/dashboard">Trading</a>
                <a href="/strategies.html">Strategies</a>
                <a href="/orchestrator.html">Orchestrator</a>
            </nav>
        </header>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Backtests</h3>
                <div class="value" id="totalBacktests">--</div>
            </div>
            <div class="stat-card">
                <h3>Total Trades</h3>
                <div class="value" id="totalTrades">--</div>
            </div>
            <div class="stat-card">
                <h3>Avg Return</h3>
                <div class="value" id="avgReturn">--%</div>
            </div>
            <div class="stat-card">
                <h3>Win Rate</h3>
                <div class="value" id="winRate">--%</div>
            </div>
            <div class="stat-card">
                <h3>Best Return</h3>
                <div class="value positive" id="bestReturn">--%</div>
            </div>
            <div class="stat-card">
                <h3>Worst Return</h3>
                <div class="value negative" id="worstReturn">--%</div>
            </div>
        </div>

        <!-- Performance Charts -->
        <div class="charts-row">
            <div class="panel">
                <h2>
                    Daily Backtest Performance
                    <div class="panel-controls">
                        <button class="active" data-days="30" onclick="changeDays(30)">30D</button>
                        <button data-days="90" onclick="changeDays(90)">90D</button>
                        <button data-days="365" onclick="changeDays(365)">1Y</button>
                    </div>
                </h2>
                <div class="chart-container tall">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
            <div class="panel">
                <h2>Cumulative Returns</h2>
                <div class="chart-container tall">
                    <canvas id="cumulativeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Strategy Comparison -->
        <div class="charts-row equal">
            <div class="panel">
                <h2>Strategy Performance</h2>
                <div class="chart-container">
                    <canvas id="strategyChart"></canvas>
                </div>
            </div>
            <div class="panel">
                <h2>Strategy Metrics</h2>
                <div style="overflow-x: auto;">
                    <table id="strategyTable">
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Backtests</th>
                                <th>Win Rate</th>
                                <th>Avg Return</th>
                                <th>Trades</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Return Distribution -->
        <div class="charts-row equal">
            <div class="panel">
                <h2>Win/Loss Distribution</h2>
                <div class="chart-container">
                    <canvas id="winLossChart"></canvas>
                </div>
            </div>
            <div class="panel">
                <h2>Return Histogram</h2>
                <div class="chart-container">
                    <canvas id="histogramChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart.js defaults
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = '#333';

        let performanceChart, cumulativeChart, strategyChart, winLossChart, histogramChart;
        let currentDays = 30;
        let allBacktests = [];

        // Initialize charts
        async function initCharts() {
            await loadAllData();
        }

        // Load all backtest data
        async function loadAllData() {
            try {
                const [summaryRes, dailyRes, recentRes] = await Promise.all([
                    fetch(`/api/backtests/summary?days=${currentDays}`),
                    fetch(`/api/backtests/daily?days=${currentDays}`),
                    fetch(`/api/backtests/recent?days=${currentDays}&limit=500`)
                ]);

                const summary = await summaryRes.json();
                const daily = await dailyRes.json();
                const recent = await recentRes.json();

                allBacktests = recent.backtests || [];

                // Update stats
                updateStats(summary);

                // Update charts
                loadPerformanceChart(daily.daily_stats || []);
                loadCumulativeChart(daily.daily_stats || []);
                loadStrategyComparison(allBacktests);
                loadReturnDistribution(allBacktests);
            } catch (e) {
                console.error('Error loading backtest data:', e);
            }
        }

        // Update stats display
        function updateStats(summary) {
            document.getElementById('totalBacktests').textContent = summary.total_backtests || 0;
            document.getElementById('totalTrades').textContent = summary.total_trades || 0;

            const avgReturn = summary.avg_return_pct || 0;
            const avgReturnEl = document.getElementById('avgReturn');
            avgReturnEl.textContent = `${avgReturn.toFixed(2)}%`;
            avgReturnEl.className = `value ${avgReturn >= 0 ? 'positive' : 'negative'}`;

            const winRate = summary.win_rate || 0;
            const winRateEl = document.getElementById('winRate');
            winRateEl.textContent = `${(winRate * 100).toFixed(1)}%`;
            winRateEl.className = `value ${winRate >= 0.5 ? 'positive' : 'negative'}`;

            document.getElementById('bestReturn').textContent = `${(summary.max_return_pct || 0).toFixed(2)}%`;
            document.getElementById('worstReturn').textContent = `${(summary.min_return_pct || 0).toFixed(2)}%`;
        }

        // Daily Performance Chart
        function loadPerformanceChart(dailyStats) {
            if (performanceChart) performanceChart.destroy();

            const labels = dailyStats.map(d => d.date);
            const avgReturns = dailyStats.map(d => d.avg_return_pct || 0);
            const counts = dailyStats.map(d => d.backtest_count || 0);

            performanceChart = new Chart(document.getElementById('performanceChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Avg Return %',
                        data: avgReturns,
                        backgroundColor: avgReturns.map(v => v >= 0 ? 'rgba(107, 203, 119, 0.7)' : 'rgba(255, 107, 107, 0.7)'),
                        borderRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'Backtests Run',
                        data: counts,
                        type: 'line',
                        borderColor: '#00d4ff',
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        pointRadius: 3,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            position: 'left',
                            title: { display: true, text: 'Return %' },
                            ticks: { callback: v => v.toFixed(1) + '%' }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'Count' },
                            grid: { drawOnChartArea: false },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Cumulative Returns Chart
        function loadCumulativeChart(dailyStats) {
            if (cumulativeChart) cumulativeChart.destroy();

            const labels = dailyStats.map(d => d.date);
            let cumulative = 0;
            const cumulativeReturns = dailyStats.map(d => {
                cumulative += (d.avg_return_pct || 0);
                return cumulative;
            });

            cumulativeChart = new Chart(document.getElementById('cumulativeChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative Return %',
                        data: cumulativeReturns,
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: { maxTicksLimit: 10 }
                        },
                        y: {
                            display: true,
                            ticks: { callback: v => v.toFixed(1) + '%' }
                        }
                    }
                }
            });
        }

        function changeDays(days) {
            currentDays = days;
            document.querySelectorAll('.panel-controls button').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.days) === days);
            });
            loadAllData();
        }

        // Strategy Comparison
        function loadStrategyComparison(backtests) {
            // Group by strategy
            const strategyMap = {};
            backtests.forEach(bt => {
                const strategy = bt.strategy_name || 'Unknown';
                if (!strategyMap[strategy]) {
                    strategyMap[strategy] = { trades: 0, wins: 0, returns: [], count: 0 };
                }
                strategyMap[strategy].trades += bt.total_trades || 0;
                if ((bt.return_pct || 0) > 0) strategyMap[strategy].wins++;
                strategyMap[strategy].returns.push(bt.return_pct || 0);
                strategyMap[strategy].count++;
            });

            const strategies = Object.entries(strategyMap).map(([name, data]) => {
                const avgReturn = data.returns.reduce((a, b) => a + b, 0) / data.returns.length;
                const winRate = data.wins / data.count;
                return {
                    strategy: name,
                    totalTrades: data.trades,
                    winRate: winRate,
                    totalReturn: avgReturn,
                    backtests: data.count
                };
            }).sort((a, b) => b.totalReturn - a.totalReturn);

            // Update table
            const tbody = document.querySelector('#strategyTable tbody');
            if (strategies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;">No strategy data yet</td></tr>';
            } else {
                tbody.innerHTML = strategies.map(s => `
                    <tr>
                        <td class="strategy-name">${s.strategy}</td>
                        <td>${s.backtests}</td>
                        <td class="${s.winRate >= 0.5 ? 'positive' : 'negative'}">${(s.winRate * 100).toFixed(1)}%</td>
                        <td class="${s.totalReturn >= 0 ? 'positive' : 'negative'}">${s.totalReturn.toFixed(2)}%</td>
                        <td>${s.totalTrades}</td>
                    </tr>
                `).join('');
            }

            // Strategy chart
            if (strategyChart) strategyChart.destroy();

            if (strategies.length > 0) {
                strategyChart = new Chart(document.getElementById('strategyChart'), {
                    type: 'radar',
                    data: {
                        labels: ['Win Rate', 'Avg Return', 'Backtests', 'Trades', 'Consistency'],
                        datasets: strategies.slice(0, 5).map((s, i) => ({
                            label: s.strategy,
                            data: [
                                s.winRate * 100,
                                Math.min(Math.max(s.totalReturn, -50), 50),
                                Math.min(s.backtests, 100),
                                Math.min(s.totalTrades / 10, 100),
                                s.winRate * 50 + Math.min(s.backtests, 50)
                            ],
                            borderColor: ['#00d4ff', '#6bcb77', '#ffd93d', '#ff6b6b', '#9b59b6'][i],
                            backgroundColor: ['rgba(0,212,255,0.1)', 'rgba(107,203,119,0.1)', 'rgba(255,217,61,0.1)', 'rgba(255,107,107,0.1)', 'rgba(155,89,182,0.1)'][i]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            r: {
                                beginAtZero: true,
                                grid: { color: '#333' },
                                angleLines: { color: '#333' }
                            }
                        }
                    }
                });
            }
        }

        // Return Distribution
        function loadReturnDistribution(backtests) {
            const returns = backtests.map(bt => bt.return_pct || 0);
            const profitable = returns.filter(r => r > 0).length;
            const losing = returns.filter(r => r <= 0).length;

            // Win/Loss pie chart
            if (winLossChart) winLossChart.destroy();

            winLossChart = new Chart(document.getElementById('winLossChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Profitable', 'Losing'],
                    datasets: [{
                        data: [profitable, losing],
                        backgroundColor: ['#6bcb77', '#ff6b6b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    cutout: '60%'
                }
            });

            // Histogram
            if (histogramChart) histogramChart.destroy();

            if (returns.length > 0) {
                const bins = {};
                const binSize = 2; // 2% bins
                returns.forEach(ret => {
                    const bin = Math.floor(ret / binSize) * binSize;
                    bins[bin] = (bins[bin] || 0) + 1;
                });

                const sortedBins = Object.keys(bins).map(Number).sort((a, b) => a - b);
                const binLabels = sortedBins.map(b => `${b}%`);
                const binValues = sortedBins.map(b => bins[b]);
                const binColors = sortedBins.map(b => b >= 0 ? 'rgba(107, 203, 119, 0.7)' : 'rgba(255, 107, 107, 0.7)');

                histogramChart = new Chart(document.getElementById('histogramChart'), {
                    type: 'bar',
                    data: {
                        labels: binLabels,
                        datasets: [{
                            label: 'Backtest Count',
                            data: binValues,
                            backgroundColor: binColors,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }

        // Initialize on load
        initCharts();

        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadAllData();
        }, 300000);
    </script>
</body>
</html>
